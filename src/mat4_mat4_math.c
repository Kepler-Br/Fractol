/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   mat4_mat4_math.c                                   :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: nsena <marvin@42.fr>                       +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2020/09/11 13:43:53 by nsena             #+#    #+#             */
/*   Updated: 2020/09/11 13:43:55 by nsena            ###   ########.fr       */
/*                                                                            */
/* ************************************************************************** */

#include "linear_alg.h"
#include <math.h>
#include "libft.h"

static void	float16_inverse3(t_mat4 *inv, t_mat4 *m)
{
	inv->s[2] = m->s[1] * m->s[6] * m->s[15] - m->s[1] * m->s[7] * m->s[14] -
				m->s[5] * m->s[2] * m->s[15] + m->s[5] * m->s[3] * m->s[14] +
				m->s[13] * m->s[2] * m->s[7] - m->s[13] * m->s[3] * m->s[6];
	inv->s[6] = -m->s[0] * m->s[6] * m->s[15] + m->s[0] * m->s[7] * m->s[14] +
				m->s[4] * m->s[2] * m->s[15] - m->s[4] * m->s[3] * m->s[14] -
				m->s[12] * m->s[2] * m->s[7] + m->s[12] * m->s[3] * m->s[6];
	inv->s[10] = m->s[0] * m->s[5] * m->s[15] - m->s[0] * m->s[7] * m->s[13] -
			m->s[4] * m->s[1] * m->s[15] + m->s[4] * m->s[3] * m->s[13] +
			m->s[12] * m->s[1] * m->s[7] - m->s[12] * m->s[3] * m->s[5];
	inv->s[14] = -m->s[0] * m->s[5] * m->s[14] + m->s[0] * m->s[6] * m->s[13] +
			m->s[4] * m->s[1] * m->s[14] - m->s[4] * m->s[2] * m->s[13] -
			m->s[12] * m->s[1] * m->s[6] + m->s[12] * m->s[2] * m->s[5];
	inv->s[3] = -m->s[1] * m->s[6] * m->s[11] + m->s[1] * m->s[7] * m->s[10] +
				m->s[5] * m->s[2] * m->s[11] - m->s[5] * m->s[3] * m->s[10] -
				m->s[9] * m->s[2] * m->s[7] + m->s[9] * m->s[3] * m->s[6];
	inv->s[7] = m->s[0] * m->s[6] * m->s[11] - m->s[0] * m->s[7] * m->s[10] -
				m->s[4] * m->s[2] * m->s[11] + m->s[4] * m->s[3] * m->s[10] +
				m->s[8] * m->s[2] * m->s[7] - m->s[8] * m->s[3] * m->s[6];
	inv->s[11] = -m->s[0] * m->s[5] * m->s[11] + m->s[0] * m->s[7] * m->s[9] +
			m->s[4] * m->s[1] * m->s[11] - m->s[4] * m->s[3] * m->s[9] -
			m->s[8] * m->s[1] * m->s[7] + m->s[8] * m->s[3] * m->s[5];
	inv->s[15] = m->s[0] * m->s[5] * m->s[10] - m->s[0] * m->s[6] * m->s[9] -
			m->s[4] * m->s[1] * m->s[10] + m->s[4] * m->s[2] * m->s[9] +
			m->s[8] * m->s[1] * m->s[6] - m->s[8] * m->s[2] * m->s[5];
}

static void	float16_inverse2(t_mat4 *inv, t_mat4 *m)
{
	inv->s[0] = m->s[5] * m->s[10] * m->s[15] - m->s[5] * m->s[11] * m->s[14] -
				m->s[9] * m->s[6] * m->s[15] + m->s[9] * m->s[7] * m->s[14] +
				m->s[13] * m->s[6] * m->s[11] - m->s[13] * m->s[7] * m->s[10];
	inv->s[4] = -m->s[4] * m->s[10] * m->s[15] + m->s[4] * m->s[11] * m->s[14] +
				m->s[8] * m->s[6] * m->s[15] - m->s[8] * m->s[7] * m->s[14] -
				m->s[12] * m->s[6] * m->s[11] + m->s[12] * m->s[7] * m->s[10];
	inv->s[8] = m->s[4] * m->s[9] * m->s[15] - m->s[4] * m->s[11] * m->s[13] -
				m->s[8] * m->s[5] * m->s[15] + m->s[8] * m->s[7] * m->s[13] +
				m->s[12] * m->s[5] * m->s[11] - m->s[12] * m->s[7] * m->s[9];
	inv->s[12] = -m->s[4] * m->s[9] * m->s[14] + m->s[4] * m->s[10] * m->s[13] +
			m->s[8] * m->s[5] * m->s[14] - m->s[8] * m->s[6] * m->s[13] -
			m->s[12] * m->s[5] * m->s[10] + m->s[12] * m->s[6] * m->s[9];
	inv->s[1] = -m->s[1] * m->s[10] * m->s[15] + m->s[1] * m->s[11] * m->s[14] +
				m->s[9] * m->s[2] * m->s[15] - m->s[9] * m->s[3] * m->s[14] -
				m->s[13] * m->s[2] * m->s[11] + m->s[13] * m->s[3] * m->s[10];
	inv->s[5] = m->s[0] * m->s[10] * m->s[15] - m->s[0] * m->s[11] * m->s[14] -
				m->s[8] * m->s[2] * m->s[15] + m->s[8] * m->s[3] * m->s[14] +
				m->s[12] * m->s[2] * m->s[11] - m->s[12] * m->s[3] * m->s[10];
	inv->s[9] = -m->s[0] * m->s[9] * m->s[15] + m->s[0] * m->s[11] * m->s[13] +
				m->s[8] * m->s[1] * m->s[15] - m->s[8] * m->s[3] * m->s[13] -
				m->s[12] * m->s[1] * m->s[11] + m->s[12] * m->s[3] * m->s[9];
	inv->s[13] = m->s[0] * m->s[9] * m->s[14] - m->s[0] * m->s[10] * m->s[13] -
			m->s[8] * m->s[1] * m->s[14] + m->s[8] * m->s[2] * m->s[13] +
			m->s[12] * m->s[1] * m->s[10] - m->s[12] * m->s[2] * m->s[9];
}

t_mat4		float16_inverse(t_mat4 m)
{
	t_mat4	inv;
	GLfloat	det;
	int		i;

	float16_inverse2(&inv, &m);
	float16_inverse3(&inv, &m);
	det = m.s[0] * inv.s[0] + m.s[1] * inv.s[4] + m.s[2] * inv.s[8] + m.s[3] *
			inv.s[12];
	if (det == 0)
	{
		ft_putstr("FFFFFFFFFFUUUUUUUUU\n");
		return (m);
	}
	det = 1.0f / det;
	i = 0;
	while (i < 16)
	{
		inv.s[i] = inv.s[i] * det;
		i++;
	}
	return (inv);
}

static void	mat4_mat4_mul2(t_mat4 *a, t_mat4 *b, t_mat4 *r)
{
	r->s[7] = a->s[4] * b->s[3] + a->s[5] * b->s[7] + a->s[6] * b->s[11] +
				a->s[7] * b->s[15];
	r->s[8] = a->s[8] * b->s[0] + a->s[9] * b->s[4] + a->s[10] * b->s[8] +
				a->s[11] * b->s[12];
	r->s[9] = a->s[8] * b->s[1] + a->s[9] * b->s[5] + a->s[10] * b->s[9] +
				a->s[11] * b->s[13];
	r->s[10] = a->s[8] * b->s[2] + a->s[9] * b->s[6] + a->s[10] * b->s[10] +
				a->s[11] * b->s[14];
	r->s[11] = a->s[8] * b->s[3] + a->s[9] * b->s[7] + a->s[10] * b->s[11] +
				a->s[11] * b->s[15];
	r->s[12] = a->s[12] * b->s[0] + a->s[13] * b->s[4] + a->s[14] * b->s[8] +
				a->s[15] * b->s[12];
	r->s[13] = a->s[12] * b->s[1] + a->s[13] * b->s[5] + a->s[14] * b->s[9] +
				a->s[15] * b->s[13];
	r->s[14] = a->s[12] * b->s[2] + a->s[13] * b->s[6] + a->s[14] * b->s[10] +
				a->s[15] * b->s[14];
	r->s[15] = a->s[12] * b->s[3] + a->s[13] * b->s[7] + a->s[14] * b->s[11] +
				a->s[15] * b->s[15];
}

t_mat4		mat4_mat4_mul(t_mat4 *a, t_mat4 *b)
{
	t_mat4	r;

	r.s[0] = a->s[0] * b->s[0] + a->s[1] * b->s[4] + a->s[2] * b->s[8] +
			a->s[3] * b->s[12];
	r.s[1] = a->s[0] * b->s[1] + a->s[1] * b->s[5] + a->s[2] * b->s[9] +
			a->s[3] * b->s[13];
	r.s[2] = a->s[0] * b->s[2] + a->s[1] * b->s[6] + a->s[2] * b->s[10] +
			a->s[3] * b->s[14];
	r.s[3] = a->s[0] * b->s[3] + a->s[1] * b->s[7] + a->s[2] * b->s[11] +
			a->s[3] * b->s[15];
	r.s[4] = a->s[4] * b->s[0] + a->s[5] * b->s[4] + a->s[6] * b->s[8] +
			a->s[7] * b->s[12];
	r.s[5] = a->s[4] * b->s[1] + a->s[5] * b->s[5] + a->s[6] * b->s[9] +
			a->s[7] * b->s[13];
	r.s[6] = a->s[4] * b->s[2] + a->s[5] * b->s[6] + a->s[6] * b->s[10] +
			a->s[7] * b->s[14];
	mat4_mat4_mul2(a, b, &r);
	return (r);
}
